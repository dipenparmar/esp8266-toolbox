#include "../missing-decls.h"

#include <ets_sys.h>
#include <osapi.h>

#define MAP_LEN 54
static const char *map[MAP_LEN][2] = {{ "%20", " "},
                                      { "%21", "!"},
                                      { "%22", "\""},
                                      { "%23", "#"},
                                      { "%24", "$"},
                                      { "%25", "%"},
                                      { "%26", "&"},
                                      { "%27", "'"},
                                      { "%28", "("},
                                      { "%29", ")"},
                                      { "%2A", "*"},  { "%2a", "*"},
                                      { "%2B", "+"},  { "%2b", "+"},
                                      { "%2C", ","},  { "%2c", ","},
                                      { "%2D", "-"},  { "%2d", "-"},
                                      { "%2E", "."},  { "%2e", "."},
                                      { "%2F", "/"},  { "%2f", "/"},
                                      { "%3A", ":"},  { "%3a", ":"},
                                      { "%3B", ";"},  { "%3b", ";"},
                                      { "%3C", "<"},  { "%3c", "<"},
                                      { "%3D", "="},  { "%3d", "="},
                                      { "%3E", ">"},  { "%3e", ">"},
                                      { "%3F", "?"},  { "%3f", "?"},
                                      { "%40", "@"},
                                      { "%5B", "["},  { "%5b", "["},
                                      { "%5C", "\\"}, { "%5c", "\\"},
                                      { "%5D", "]"},  { "%5d", "]"},
                                      { "%5E", "^"},  { "%5e", "^"},
                                      { "%5F", "_"},  { "%5f", "_"},
                                      { "%60", "`"},
                                      { "%7B", "{"},  { "%7b", "{"},
                                      { "%7C", "|"},  { "%7c", "|"},
                                      { "%7D", "}"},  { "%7d", "}"},
                                      { "%7E", "~"},  { "%7e", "~"},
                                     };

ICACHE_FLASH_ATTR void url_decode(char *s) {
    size_t l, i;
    char *p;
    uint8_t f;

    l = os_strlen(s) + 1;
    while (1) {
        f = 0;
        
        for (i=0; i<MAP_LEN; i++) {
            if ((p = strstr(s, map[i][0])) != NULL) {
                *p = map[i][1][0];
                os_memmove(p+1, p+3, l - ((p+3)-s));
                l -= 2;
                f = 1;
            }
        }

        if (f == 0)
            break;
    }
}
